name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  checks: read
  issues: write
  repository-projects: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: [] # Will wait for required status checks set in branch protection
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: '${{ secrets.AUTO_TOKEN }}'

      - name: Enable auto-merge for patch and minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          echo "Enabling auto-merge for ${{ steps.metadata.outputs.update-type }} update for ${{ steps.metadata.outputs.dependency-names }}"
          gh pr merge --auto --squash ${{ github.event.pull_request.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_TOKEN }}

      - name: Comment on major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "üö® **Major Version Update Detected**

          This PR contains a major version update for **${{ steps.metadata.outputs.dependency-names }}**.

          Major updates may contain breaking changes and require manual review before merging.

          Please review the changelog and test thoroughly before merging."
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_TOKEN }}

      - name: Enable auto-merge for GitHub Actions updates
        if: steps.metadata.outputs.package-ecosystem == 'github_actions'
        run: |
          echo "Enabling auto-merge for GitHub Actions update for ${{ steps.metadata.outputs.dependency-names }}"
          # Check if this PR modifies workflow files
          workflow_files=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path | select(startswith(".github/workflows/"))')
          if [ -z "$workflow_files" ]; then
            echo "No workflow files modified, proceeding with auto-merge"
            gh pr merge --auto --squash ${{ github.event.pull_request.number }}
          else
            echo "Workflow files detected, skipping auto-merge (requires manual review)"
            gh pr comment ${{ github.event.pull_request.number }} --body "‚ö†Ô∏è **Workflow File Update**\n\nThis PR updates GitHub workflow files and requires manual review for security reasons.\n\nWorkflow files: \`$workflow_files\`"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_TOKEN }}
